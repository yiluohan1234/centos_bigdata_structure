#!/bin/bash
source "/vagrant/scripts/common.sh"

install_ssh() {
    if [ ! -f ~/.ssh/id_rsa ];then
        expect -c "
            spawn ssh-keygen
            expect {
                \"Enter file in which to save the*\" { send \"\r\"; exp_continue}
                \"Overwrite*\" { send \"n\r\" ; exp_continue}
                \"Enter passphrase*\" { send \"\r\"; exp_continue}
                \"Enter same passphrase again:\" { send \"\r\" ; exp_continue}
            }";
    fi
    i=0
    for ip in ${HOSTNAME_LIST[@]};do
        expect -c "
            set timeout 5;
            spawn ssh-copy-id -i ${ip};
            expect {
                \"*assword\" { send \"${PASSWD_LIST[$i]}\r\";exp_continue}
                \"yes/no\" { send \"yes\r\"; exp_continue }
                eof {exit 0;}
            }";
        echo "========主机IP为：${ip}免登录执行完成========"
        i=$(( i+1 ))
    done
}
install_ssh
if [ "${IS_VAGRANT}" == "true" ];then
    install_ssh
fi